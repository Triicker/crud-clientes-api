<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - API do IBGE</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px;
        }
        .debug { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 10px 0; 
            font-family: monospace;
        }
        select { 
            padding: 8px 12px; 
            margin: 5px; 
            min-width: 200px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        .filters-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Teste - Integra√ß√£o com API do IBGE</h1>
    
    <div class="test-section">
        <h2>Status da API</h2>
        <div class="debug" id="apiStatus">Testando conex√£o...</div>
    </div>

    <div class="test-section">
        <h2>Filtros Din√¢micos</h2>
        
        <div class="filters-row">
            <label for="estadosSelect">Estado:</label>
            <select id="estadosSelect">
                <option value="">Carregando estados...</option>
            </select>
            
            <label for="cidadesSelect">Cidade:</label>
            <select id="cidadesSelect">
                <option value="">Selecione um estado primeiro</option>
            </select>
            
            <label for="microregioesSelect">Microrregi√£o:</label>
            <select id="microregioesSelect">
                <option value="">Selecione um estado primeiro</option>
            </select>
        </div>
        
        <div class="filters-row">
            <button onclick="testEstados()">Testar Estados</button>
            <button onclick="testMunicipios()">Testar Munic√≠pios (SP)</button>
            <button onclick="testMicrorregioes()">Testar Microrregi√µes (SP)</button>
            <button onclick="clearCache()">Limpar Cache</button>
        </div>
        
        <div class="debug" id="filterDebug">Aguardando teste...</div>
    </div>

    <div class="test-section">
        <h2>Cache Status</h2>
        <div class="debug" id="cacheStatus">Verificando cache...</div>
        <button onclick="updateCacheStatus()">Atualizar Status do Cache</button>
    </div>

    <!-- Scripts -->
    <script src="ibge-api.js"></script>
    
    <script>
        const apiStatus = document.getElementById('apiStatus');
        const filterDebug = document.getElementById('filterDebug');
        const cacheStatus = document.getElementById('cacheStatus');
        const estadosSelect = document.getElementById('estadosSelect');
        const cidadesSelect = document.getElementById('cidadesSelect');
        const microregioesSelect = document.getElementById('microregioesSelect');

        // Inicializa√ß√£o
        async function init() {
            try {
                apiStatus.innerHTML = 'üîÑ Testando conex√£o com IBGE...';
                
                // Testar conex√£o b√°sica
                await ibgeApiClient.getEstados();
                apiStatus.innerHTML = '‚úÖ Conex√£o com IBGE funcionando!';
                
                // Carregar filtros
                await loadFilters();
                
            } catch (error) {
                apiStatus.innerHTML = `‚ùå Erro na conex√£o: ${error.message}`;
            }
        }

        // Carregar filtros
        async function loadFilters() {
            try {
                // Carregar estados
                await populateEstadosSelect(estadosSelect, true);
                
                // Event listeners
                estadosSelect.addEventListener('change', async () => {
                    const uf = estadosSelect.value;
                    
                    if (uf) {
                        filterDebug.innerHTML = `üîÑ Carregando dados para ${uf}...`;
                        
                        // Carregar cidades e microrregi√µes em paralelo
                        await Promise.all([
                            populateMunicipiosSelect(cidadesSelect, uf, true),
                            populateMicroregioesSelect(microregioesSelect, uf, true)
                        ]);
                        
                        filterDebug.innerHTML = `‚úÖ Dados carregados para ${uf}`;
                    } else {
                        cidadesSelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                        microregioesSelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                        filterDebug.innerHTML = 'Filtros resetados';
                    }
                    
                    updateCacheStatus();
                });
                
                filterDebug.innerHTML = '‚úÖ Filtros inicializados';
                
            } catch (error) {
                filterDebug.innerHTML = `‚ùå Erro ao carregar filtros: ${error.message}`;
            }
        }

        // Testes individuais
        async function testEstados() {
            try {
                filterDebug.innerHTML = 'üîÑ Testando busca de estados...';
                const estados = await ibgeApiClient.getEstados();
                filterDebug.innerHTML = `‚úÖ ${estados.length} estados carregados: ${estados.slice(0, 3).map(e => e.sigla).join(', ')}...`;
            } catch (error) {
                filterDebug.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }

        async function testMunicipios() {
            try {
                filterDebug.innerHTML = 'üîÑ Testando munic√≠pios de SP...';
                const municipios = await ibgeApiClient.getMunicipiosPorEstado('SP');
                filterDebug.innerHTML = `‚úÖ ${municipios.length} munic√≠pios em SP: ${municipios.slice(0, 3).map(m => m.nome).join(', ')}...`;
            } catch (error) {
                filterDebug.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }

        async function testMicrorregioes() {
            try {
                filterDebug.innerHTML = 'üîÑ Testando microrregi√µes de SP...';
                const microrregioes = await ibgeApiClient.getMicrorregioesPorEstado('SP');
                filterDebug.innerHTML = `‚úÖ ${microrregioes.length} microrregi√µes em SP: ${microrregioes.slice(0, 3).map(m => m.nome).join(', ')}...`;
            } catch (error) {
                filterDebug.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }

        function clearCache() {
            ibgeApiClient.clearCache();
            filterDebug.innerHTML = 'üóëÔ∏è Cache limpo!';
            updateCacheStatus();
        }

        function updateCacheStatus() {
            const status = ibgeApiClient.getCacheStatus();
            cacheStatus.innerHTML = `
                üì¶ Cache Status:<br>
                ‚Ä¢ Itens em cache: ${status.size}<br>
                ‚Ä¢ Chaves: ${status.keys.join(', ')}<br>
                ‚Ä¢ Timeout: ${status.timeout} minutos
            `;
        }

        // Executar inicializa√ß√£o
        init();
        updateCacheStatus();
    </script>
</body>
</html>